uC/OS-III 通过**空闲任务计数法**实现 CPU 利用率的统计，其核心原理是**利用空闲任务运行时间反推 CPU 忙碌程度**。以下是具体实现机制：

---

### 🔧 一、核心原理：空闲任务计数法
1. **空闲任务的作用**  
   uC/OS-III 在初始化时会创建最低优先级的**空闲任务**（`OS_IdleTask`），当 CPU 无其他任务运行时，系统会执行此任务。空闲任务中持续对计数器 `OSIdleTaskCtr` 进行自增操作。

2. **最大空闲计数基准**  
   系统启动时需调用 **`OSStatTaskCPUUsageInit()`** 函数进行初始化。此时系统会故意保持空闲状态一段时间（通常 100ms），记录此时间段内 `OSIdleTaskCtr` 的最大值，即 **`OSStatTaskCtrMax`**（代表 100% 空闲状态）。

3. **实时空闲计数**  
   在正常运行中，统计任务定期（如每秒 10 次）采样当前空闲计数 `OSStatTaskCtrRun`（即 `OSIdleTaskCtr` 的瞬时值）。

4. **利用率计算公式**  
   CPU 利用率由以下公式计算：  
   **`CPU利用率 (%) = 100 × (1 - OSStatTaskCtrRun / OSStatTaskCtrMax)`**  
   - 若 `OSStatTaskCtrRun = OSStatTaskCtrMax`，利用率 = 0%（完全空闲）  
   - 若 `OSStatTaskCtrRun = 0`，利用率 = 100%（无空闲时间）。

---

### ⚙️ 二、统计任务的运作机制
1. **任务启用条件**  
   需在配置文件 `os_cfg.h` 中启用宏 **`OS_CFG_STAT_TASK_EN = 1`**，系统才会创建统计任务 `OS_StatTask`。

2. **任务优先级与调度**  
   统计任务优先级默认为 `OS_CFG_PRIO_MAX-2`（倒数第二低）。其周期性执行以下操作：  
   - 读取当前空闲计数 `OSStatTaskCtrRun`  
   - 重置 `OSStatTaskCtr` 为 0，准备下一周期计数  
   - 按公式计算 CPU 利用率，结果存入全局变量 **`OSStatTaskCPUUsage`**  
   - 更新历史最大利用率 `OSStatTaskCPUUsageMax`

3. **动态精度优化**  
   为避免整数除法精度损失，系统根据 `OSStatTaskCtrMax` 的规模动态调整计算系数（见下表）：  

| **空闲计数范围**         | **乘数 (ctr_mult)** | **除数 (ctr_div)** |  
|--------------------------|---------------------|-------------------|  
| < 400,000                | 10000               | 1                 |  
| 400,000 ~ 4,000,000      | 1000                | 10                |  
| 4,000,000 ~ 40,000,000   | 100                 | 100               |  
| 40,000,000 ~ 400,000,000 | 10                  | 1000              |  
| > 400,000,000            | 1                   | 10000             |  

   最终计算式优化为：  
   **`OSStatTaskCPUUsage = 10000 - (ctr_mult × OSStatTaskCtrRun) / (OSStatTaskCtrMax / ctr_div)`**  
   （结果需除以 100 得到百分比值）

---

### ⚠️ 三、关键限制与注意事项
1. **初始化要求**  
   必须在 `main()` 函数创建的第一个应用任务中调用 **`OSStatTaskCPUUsageInit()`**，否则无法获取准确的 `OSStatTaskCtrMax`。

2. **计数器溢出风险**  
   `OSIdleTaskCtr` 为 32 位变量，在 100MHz CPU 下约 **59.6 分钟**溢出。统计任务需定期重置计数器（通常周期远小于溢出时间）。

3. **非精确性**  
   此方法为**间接采样**，精度受以下因素影响：  
   - 空闲任务被高优先级任务阻塞时，计数偏低（利用率虚高）  
   - 统计任务执行频率（`OS_CFG_STAT_TASK_RATE_HZ`）越低，实时性越差

4. **多任务扩展功能**  
   若启用宏 `OS_CFG_TASK_PROFILE_EN`，统计任务还会计算**各任务的 CPU 占用率**，原理类似：记录任务运行周期计数器 `CyclesTotal`，与总周期对比得出占比。

---

### 💎 总结
uC/OS-III 的 CPU 利用率统计依赖于**空闲任务的周期性计数**与**统计任务的动态计算**，以全局变量形式输出结果。其优势在于实现轻量、开销低，适合资源受限的嵌入式场景；但需注意初始化顺序、计数器溢出及精度局限。实际开发中，建议结合任务级占用统计（`OS_CFG_TASK_PROFILE_EN`）综合分析性能瓶颈。