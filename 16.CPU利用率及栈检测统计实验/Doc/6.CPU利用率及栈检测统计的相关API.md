# 中断管理的相关数据结构

```c
/* 中断队列控制块 */
typedef  struct  os_int_q            OS_INT_Q;

#if OS_CFG_ISR_POST_DEFERRED_EN > 0u
struct  os_int_q {
    OS_OBJ_TYPE          Type;                              /* Type of object placed in the circular list             */
    OS_INT_Q            *NextPtr;                           /* Pointer to next OS_INT_Q in  circular list             */
    void                *ObjPtr;                            /* Pointer to object placed in the queue                  */
    void                *MsgPtr;                            /* Pointer to message if posting to a message queue       */
    OS_MSG_SIZE          MsgSize;                           /* Message Size       if posting to a message queue       */
    OS_FLAGS             Flags;                             /* Value of flags if posting to an event flag group       */
    OS_OPT               Opt;                               /* Post Options                                           */
    CPU_TS               TS;                                /* Timestamp                                              */
};
#endif                                                          
```

# 用户可以使用的API

无，只要在`os_cfg.h`中设置`OS_CFG_ISR_POST_DEFERRED_EN`不为`0`即可使用中断延迟发布队列。不过需要在中断服务函数中使用以下两个函数开关中断：

```c
void          OSIntEnter                (void);
void          OSIntExit                 (void);
```

# 系统内部的底层变量和函数（一般带下划线），请用户不要使用

```
extern  OS_INT_Q    * const OSCfg_IntQBasePtr;
extern  OS_OBJ_QTY    const OSCfg_IntQSize;
extern  CPU_INT32U    const OSCfg_IntQSizeRAM;
extern  CPU_STK     * const OSCfg_IntQTaskStkBasePtr;
extern  CPU_STK_SIZE  const OSCfg_IntQTaskStkLimit;
extern  CPU_STK_SIZE  const OSCfg_IntQTaskStkSize;
extern  CPU_INT32U    const OSCfg_IntQTaskStkSizeRAM;

#if OS_CFG_ISR_POST_DEFERRED_EN > 0u
/* 中断延迟发布任务的初始化：在系统初始化就会被运行，为OS_IntQTask()创建一个任务 */
void          OS_IntQTaskInit           (OS_ERR                *p_err);

/* 中断延迟发布过程：发送消息的函数是在中断中被调用，此时就不该立即发送消息， 
而是将消息的发送放在指定发布任务中，此时系统就将消息发布到中断消息队列中，等待到中断发布任务唤醒再发送消息 */
void          OS_IntQPost               (OS_OBJ_TYPE            type,
                                         void                  *p_obj,
                                         void                  *p_void,
                                         OS_MSG_SIZE            msg_size,
                                         OS_FLAGS               flags,
                                         OS_OPT                 opt,
                                         CPU_TS                 ts,
                                         OS_ERR                *p_err);
                                         
/* 该函数被OS_IntQTask调用：如果中断队列里还存在未发布的内核对象，
就调用OS_IntQRePost()函数发布中断队列里的内核对象，其实该函数才是真正的发布操作 */
void          OS_IntQRePost             (void);

/* 中断延迟发布任务：在中断中将消息放入中断队列后，将优先级最高的中断延迟发布任务设置为就绪态，
接着继续执行中断，在退出所有中断嵌套后，第一个执行的任务就是OS_IntQTask() */
void          OS_IntQTask               (void                  *p_arg);
#endif
```