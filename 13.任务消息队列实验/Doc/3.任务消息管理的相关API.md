# 任务消息的相关数据结构

```c
/****************** 消息池管理 ******************/
/* 消息池控制块 */
typedef  struct  os_msg_pool         OS_MSG_POOL;
struct  os_msg_pool {                                       /* OS_MSG POOL                                            */
    OS_MSG              *NextPtr;                           /* Pointer to next message                                */
    OS_MSG_QTY           NbrFree;                           /* Number of messages available from this pool            */
    OS_MSG_QTY           NbrUsed;                           /* Current number of messages used                        */
    OS_MSG_QTY           NbrUsedMax;                        /* Peak number of messages used                           */
};

/* 消息池里的消息 */
typedef  struct  os_msg              OS_MSG;
struct  os_msg {                                            /* MESSAGE CONTROL BLOCK                                  */
    OS_MSG              *NextPtr;                           /* Pointer to next message                                */
    void                *MsgPtr;                            /* Actual message                                         */
    OS_MSG_SIZE          MsgSize;                           /* Size of the message (in # bytes)                       */
    CPU_TS               MsgTS;                             /* Time stamp of when message was sent                    */
};

/****************** 任务消息队列管理 ******************/
/* 任务消息队列核心：记录任务消息队列中的相关信息 */
typedef  struct  os_msg_q            OS_MSG_Q;
struct  os_msg_q {                                          /* OS_MSG_Q                                               */
    OS_MSG              *InPtr;                             /* Pointer to next OS_MSG to be inserted  in   the queue  */
    OS_MSG              *OutPtr;                            /* Pointer to next OS_MSG to be extracted from the queue  */
    OS_MSG_QTY           NbrEntriesSize;                    /* Maximum allowable number of entries in the queue       */
    OS_MSG_QTY           NbrEntries;                        /* Current number of entries in the queue                 */
    OS_MSG_QTY           NbrEntriesMax;                     /* Peak number of entries in the queue                    */
};

/* “任务消息队列核心”并无记录等待队列的相关信息 */
```

# 用户可以使用的API（仅列举部分）

```c
void         *OSTaskQPend               (OS_TICK                timeout,
                                         OS_OPT                 opt,
                                         OS_MSG_SIZE           *p_msg_size,
                                         CPU_TS                *p_ts,
                                         OS_ERR                *p_err);

void          OSTaskQPost               (OS_TCB                *p_tcb,
                                         void                  *p_void,
                                         OS_MSG_SIZE            msg_size,
                                         OS_OPT                 opt,
                                         OS_ERR                *p_err);                                                                
```

# 系统内部的底层函数（一般带下划线），请用户不要使用

```
/****************** 消息池管理 ******************/
/* 消息池初始化：在系统初始化中被调用 */
void          OS_MsgQInit               (OS_MSG_Q              *p_msg_q,
                                         OS_MSG_QTY             size);
/* 把消息队列上的所有消息放回到消息池中 */                                    
OS_MSG_QTY    OS_MsgQFreeAll            (OS_MSG_Q              *p_msg_q);

/* 把消息释放回消息池中（被 OSTaskQPend() 调用） */
void         *OS_MsgQGet                (OS_MSG_Q              *p_msg_q,
                                         OS_MSG_SIZE           *p_msg_size,
                                         CPU_TS                *p_ts,
                                         OS_ERR                *p_err);

/* 从消息池中获取一个消息（被 OSTaskQPost() 调用） */
void          OS_MsgQPut                (OS_MSG_Q              *p_msg_q,
                                         void                  *p_void,
                                         OS_MSG_SIZE            msg_size,
                                         OS_OPT                 opt,
                                         CPU_TS                 ts,
                                         OS_ERR                *p_err); 
                                         
/****************** 等待/阻塞队列管理 ******************/     
/* 把消息发送给任务 */                        
void          OS_Post                   (OS_PEND_OBJ           *p_obj,
                                         OS_TCB                *p_tcb,
                                         void                  *p_void,
                                         OS_MSG_SIZE            msg_size,
                                         CPU_TS                 ts); 

/* 阻塞当前任务：将当前任务脱离就绪列表，并根据用户指定的阻塞时间插入到节拍列表和队列等待列表 */                                    
void          OS_Pend                   (OS_PEND_DATA          *p_pend_data,
                                         OS_PEND_OBJ           *p_obj,
                                         OS_STATE               pending_on,
                                         OS_TICK                timeout);
                                         
/****************** 消息 & 消息队列管理 ******************/   
void          OS_TaskQPost              (OS_TCB                *p_tcb,
                                         void                  *p_void,
                                         OS_MSG_SIZE            msg_size,
                                         OS_OPT                 opt,
                                         CPU_TS                 ts,
                                         OS_ERR                *p_err); 
                                         
/* 注意没有 OS_TaskQPend 函数 */
```