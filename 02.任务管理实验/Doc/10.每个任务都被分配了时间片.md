在UCOSIII中，当多个任务具有相同优先级且处于就绪状态时，系统通过**时间片轮转调度（Round-Robin Scheduling）**实现公平的CPU资源分配。以下是其工作流程和关键机制的详细说明：

---

### 🔄 **一、时间片轮转的核心流程**
1. **就绪队列管理**  
   - 同优先级任务被组织在同一个就绪队列（`OSRdyList[prio]`）中，以双向链表形式存储。  
   - 任务按**先入先出（FIFO）**顺序排队，新任务插入队尾。

2. **时间片分配**  
   - 每个任务被分配固定长度的时间片（单位：系统时钟节拍，如1ms@1kHz时钟）。  
   - **默认时间片**：全局默认值可通过`OSSchedRoundRobinCfg()`设置（如100个节拍）；  
   **任务级时间片**：创建任务时通过`OSTaskCreate()`的`time_quanta`参数单独指定。

3. **时间片消耗与切换**  
   - **时钟中断触发**：每次系统时钟节拍（Tick）中断时，当前运行任务的**时间片计数器（`TimeQuantaCtr`）减1**。  
   - **计数器归零**：  
     - 当前任务被移出就绪队列队首，插入队尾；  
     - 调度器选择队首新任务运行，并重置其时间片计数器。

---

### ⚙️ **二、关键机制与配置**
1. **启用时间片轮转**  
   - **编译时配置**：在`os_cfg.h`中定义宏`OS_CFG_SCHED_ROUND_ROBIN_EN=1`。  
   - **运行时初始化**：调用`OSSchedRoundRobinCfg(DEF_ENABLED, dflt_time_quanta, &err)`启用功能。  
   ```c
   #if OS_CFG_SCHED_ROUND_ROBIN_EN
       OSSchedRoundRobinCfg(DEF_ENABLED, 10, &err); // 启用，默认时间片=10节拍
   #endif
   ```

2. **主动放弃时间片**  
   任务可在时间片用完前调用`OSSchedRoundRobinYield(&err)`主动让出CPU，立即触发同优先级任务切换。  
   ```c
   void Task(void *p_arg) {
       while (1) {
           // 部分逻辑执行后主动让出
           if (need_yield) OSSchedRoundRobinYield(&err);
       }
   }
   ```

3. **时间片未用完的处理**  
   - 若任务因等待事件（如信号量）提前阻塞，剩余时间片**丢弃不保存**；  
   - 下次就绪时重新获得完整时间片。

---

### ⚠️ **三、注意事项**
1. **时间片长度设置**  
   - **过短**：频繁切换增加开销，任务可能未完成核心逻辑；  
   **过长**：低响应性，同优先级任务等待时间增加。  
   **建议**：根据任务最坏执行时间（WCET）调试，通常5~100ms。

2. **中断安全**  
   - 时间片计数和任务切换在**时钟中断上下文**执行，需保证操作原子性。

3. **与抢占式调度的协同**  
   - 时间片轮转仅在同优先级任务间生效；  
   - 高优先级任务就绪时，立即抢占当前任务（无论时间片是否用完）。

---

### 💎 **四、示例场景**
假设任务A、B优先级均为4，时间片各为50ms：  
1. **初始状态**：A在队首，B在队尾。  
2. **A运行**：消耗50ms后时间片归零，A移至队尾，B开始运行。  
3. **B运行**：若B运行30ms后主动调用`OSSchedRoundRobinYield()`，则立即切换回A，A剩余时间片为20ms。

---

### 📊 **配置与行为对比**
| **配置项**                | **默认值/行为**                     | **可调整范围**               |  
|--------------------------|-----------------------------------|-----------------------------|  
| 时间片长度（全局）         | `OSCfg_TickRate_Hz/10` (e.g., 100ms@1kHz) | 任意节拍数（>0）        |  
| 时间片长度（任务级）       | 继承全局默认值                     | 创建任务时单独指定       |  
| 未用完时间片               | 丢弃，下次重置完整时间片            | 不可保留                |  
| 调度触发点                | Tick中断或主动`Yield`              | 不可配置            |  

> **最佳实践**：  
> - 同优先级任务应设计为**短时执行**，避免长时间阻塞；  
> - 高负载场景下，启用时间片轮转需权衡**公平性**与**切换开销**。  

通过上述机制，UCOSIII确保了同优先级任务的公平调度，同时与抢占式策略无缝协同，满足实时系统的确定性需求。