# 消息的相关数据结构

```c
/****************** 消息池管理 ******************/
/* 消息池控制块 */
typedef  struct  os_msg_pool         OS_MSG_POOL;
struct  os_msg_pool {                                       /* OS_MSG POOL                                            */
    OS_MSG              *NextPtr;                           /* Pointer to next message                                */
    OS_MSG_QTY           NbrFree;                           /* Number of messages available from this pool            */
    OS_MSG_QTY           NbrUsed;                           /* Current number of messages used                        */
    OS_MSG_QTY           NbrUsedMax;                        /* Peak number of messages used                           */
};

/* 消息池里的消息 */
typedef  struct  os_msg              OS_MSG;
struct  os_msg {                                            /* MESSAGE CONTROL BLOCK                                  */
    OS_MSG              *NextPtr;                           /* Pointer to next message                                */
    void                *MsgPtr;                            /* Actual message                                         */
    OS_MSG_SIZE          MsgSize;                           /* Size of the message (in # bytes)                       */
    CPU_TS               MsgTS;                             /* Time stamp of when message was sent                    */
};

/****************** 消息队列管理 ******************/
/* 消息队列控制块，但其实它记录着两种队列 */
typedef  struct  os_q                OS_Q;
struct  os_q {                                              /* Message Queue                                          */                                                   
    OS_OBJ_TYPE          Type;                              /* Should be set to OS_OBJ_TYPE_Q                         */
    CPU_CHAR            *NamePtr;                           /* Pointer to Message Queue Name (NUL terminated ASCII)   */
    OS_PEND_LIST         PendList;                          /* List of tasks waiting on message queue                 */
    OS_MSG_Q             MsgQ;                              /* List of messages                                       */
};

/* 等待队列（注意这是许多内核对象共用的数据结构） */
typedef  struct  os_pend_list        OS_PEND_LIST;
struct  os_pend_list {
    OS_PEND_DATA        *HeadPtr;
    OS_PEND_DATA        *TailPtr;
    OS_OBJ_QTY           NbrEntries;
};

/* 消息队列核心：记录消息队列中的相关信息 */
typedef  struct  os_msg_q            OS_MSG_Q;
struct  os_msg_q {                                          /* OS_MSG_Q                                               */
    OS_MSG              *InPtr;                             /* Pointer to next OS_MSG to be inserted  in   the queue  */
    OS_MSG              *OutPtr;                            /* Pointer to next OS_MSG to be extracted from the queue  */
    OS_MSG_QTY           NbrEntriesSize;                    /* Maximum allowable number of entries in the queue       */
    OS_MSG_QTY           NbrEntries;                        /* Current number of entries in the queue                 */
    OS_MSG_QTY           NbrEntriesMax;                     /* Peak number of entries in the queue                    */
};
```

# 用户可以使用的API（仅列举部分）

```c
/* 创建消息队列 */                                       
void          OSQCreate                 (OS_Q                  *p_q,
                                         CPU_CHAR              *p_name,
                                         OS_MSG_QTY             max_qty,
                                         OS_ERR                *p_err);
                                         
/* 删除消息队列 */                                          
OS_OBJ_QTY    OSQDel                    (OS_Q                  *p_q,
                                         OS_OPT                 opt,
                                         OS_ERR                *p_err);
                                         
/* 消息队列发送函数：任务将消息发送到消息队列中 */   
void          OSQPost                   (OS_Q                  *p_q,
                                         void                  *p_void,
                                         OS_MSG_SIZE            msg_size,
                                         OS_OPT                 opt,
                                         OS_ERR                *p_err);  

/* 消息队列接收函数：任务从消息队列中获取消息 */                                                                                
void         *OSQPend                   (OS_Q                  *p_q,
                                         OS_TICK                timeout,
                                         OS_OPT                 opt,
                                         OS_MSG_SIZE           *p_msg_size,
                                         CPU_TS                *p_ts,
                                         OS_ERR                *p_err);                                                                   
```

# 系统内部的底层函数（一般带下划线），请用户不要使用

```
/****************** 消息池管理 ******************/
/* 消息池初始化：在系统初始化中被调用 */
void          OS_MsgQInit               (OS_MSG_Q              *p_msg_q,
                                         OS_MSG_QTY             size);
/* 把消息队列上的所有消息放回到消息池中 */                                    
OS_MSG_QTY    OS_MsgQFreeAll            (OS_MSG_Q              *p_msg_q);

/* 把消息释放回消息池中（被 OSQPend() 调用） */
void         *OS_MsgQGet                (OS_MSG_Q              *p_msg_q,
                                         OS_MSG_SIZE           *p_msg_size,
                                         CPU_TS                *p_ts,
                                         OS_ERR                *p_err);

/* 从消息池中获取一个消息（被 OSQPost() 调用） */
void          OS_MsgQPut                (OS_MSG_Q              *p_msg_q,
                                         void                  *p_void,
                                         OS_MSG_SIZE            msg_size,
                                         OS_OPT                 opt,
                                         CPU_TS                 ts,
                                         OS_ERR                *p_err); 
                                         
/****************** 等待队列管理 ******************/
void          OS_PendListInit           (OS_PEND_LIST          *p_pend_list);

void          OS_PendObjDel             (OS_PEND_OBJ           *p_obj,
                                         OS_TCB                *p_tcb,
                                         CPU_TS                 ts);
                                         
void          OS_Post                   (OS_PEND_OBJ           *p_obj,
                                         OS_TCB                *p_tcb,
                                         void                  *p_void,
                                         OS_MSG_SIZE            msg_size,
                                         CPU_TS                 ts); 
                                         
void          OS_Pend                   (OS_PEND_DATA          *p_pend_data,
                                         OS_PEND_OBJ           *p_obj,
                                         OS_STATE               pending_on,
                                         OS_TICK                timeout);
                                         
/****************** 消息队列管理 ******************/   
/* 清除消息队列内容 */
void          OS_QClr                   (OS_Q                  *p_q);

void          OS_QInit                  (OS_ERR                *p_err);

void          OS_QPost                  (OS_Q                  *p_q,
                                         void                  *p_void,
                                         OS_MSG_SIZE            msg_size,
                                         OS_OPT                 opt,
                                         CPU_TS                 ts,
                                         OS_ERR                *p_err);    
                                         
/* 注意没有 OS_QPend 函数 */
```